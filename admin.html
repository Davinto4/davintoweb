<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Admin Dashboard</title>
  <link rel="stylesheet" href="style.css" />
  <style>
    body { font-family: sans-serif; padding: 20px; background: #f2f2f2; }
    .hidden { display: none; }
    table, th, td { border: 1px solid #ccc; border-collapse: collapse; padding: 8px; }
    .admin-section { margin-top: 20px; background: white; padding: 20px; border-radius: 10px; }
    .btn { padding: 6px 12px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; }
    .btn.danger { background: red; }
  </style>
</head>
<body>
  <h2>DavintoWeb Admin Panel</h2>

  <!-- Login Form -->
  <div id="login-section">
    <h3>Login</h3>
    <input id="email" type="email" placeholder="Email" /><br /><br />
    <input id="password" type="password" placeholder="Password" /><br /><br />
    <button class="btn" onclick="login()">Login</button>
  </div>

  <!-- Dashboard -->
  <div id="dashboard" class="hidden">

    <p>Welcome, <span id="userEmail"></span> | <button onclick="logout()" class="btn danger">Logout</button></p>
    <div id="verify-email-box" class="admin-section hidden">
      <p><strong>Your email is not verified.</strong></p>
      <button onclick="sendVerification()" class="btn">Resend Verification Email</button>
    </div>

    <!-- Role Display -->
    <div class="admin-section">
      <p><strong>Role:</strong> <span id="userRole">Loading...</span></p>
    </div>

    <!-- Portfolio Upload Form -->
    <div class="admin-section" id="portfolio-form-section">
      <h3>Post New Portfolio</h3>
      <input id="projectTitle" placeholder="Project Title" /><br /><br />
      <input id="projectImage" placeholder="Image URL" /><br /><br />
      <input id="projectLink" placeholder="Project Link" /><br /><br />
      <textarea id="projectDesc" placeholder="Project Description"></textarea><br /><br />
      <button class="btn" onclick="postPortfolio()">Post Project</button>
    </div>

    <!-- Portfolio Items -->
    <div class="admin-section">
      <h3>Portfolio Entries</h3>
      <table id="portfolioTable"><thead>
        <tr><th>Title</th><th>Image</th><th>Link</th><th>Description</th><th>Actions</th></tr>
      </thead><tbody></tbody></table>
      <br />
      <button class="btn" onclick="exportTable('portfolioTable', 'portfolio.csv')">Export Portfolio CSV</button>
    </div>

    <!-- Payment Confirmations -->
    <div class="admin-section">
      <h3>Payment Confirmations</h3>
      <table id="paymentTable"><thead>
        <tr><th>Name</th><th>Email</th><th>Account</th><th>Service</th><th>Message</th><th>Actions</th></tr>
      </thead><tbody></tbody></table>
      <br />
      <button class="btn" onclick="exportTable('paymentTable', 'payments.csv')">Export Payments CSV</button>
    </div>
  </div>

  <!-- Firebase Scripts -->
  <script src="https://www.gstatic.com/firebasejs/10.3.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.3.1/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.3.1/firebase-database.js"></script>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyBz7fdasuQLxIFLq2TJzPAQrDTJq6h_YT8",
      authDomain: "davintoweb-payments.firebaseapp.com",
      databaseURL: "https://davintoweb-payments-default-rtdb.firebaseio.com",
      projectId: "davintoweb-payments",
      storageBucket: "davintoweb-payments.appspot.com",
      messagingSenderId: "667742200333",
      appId: "1:667742200333:web:cf75f6cef6798eed432b44"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    const auth = firebase.auth();

    function login() {
      const email = document.getElementById("email").value;
      const pass = document.getElementById("password").value;
      auth.signInWithEmailAndPassword(email, pass)
        .then(() => location.reload())
        .catch(err => alert(err.message));
    }

    function logout() {
      auth.signOut().then(() => location.reload());
    }

    function sendVerification() {
      auth.currentUser.sendEmailVerification().then(() => {
        alert("Verification email sent.");
      });
    }

    function exportTable(id, filename) {
      let csv = [];
      const rows = document.querySelectorAll(`#${id} tr`);
      for (let row of rows) {
        const cols = row.querySelectorAll("td, th");
        const rowData = Array.from(cols).map(col => `"${col.innerText}"`);
        csv.push(rowData.join(","));
      }
      const blob = new Blob([csv.join("\n")], { type: "text/csv" });
      const link = document.createElement("a");
      link.href = URL.createObjectURL(blob);
      link.download = filename;
      link.click();
    }

    function postPortfolio() {
      const title = projectTitle.value;
      const image = projectImage.value;
      const link = projectLink.value;
      const desc = projectDesc.value;
      const newRef = db.ref("portfolio").push();
      newRef.set({ title, image, link, desc });
      alert("Portfolio posted!");
    }

    function deleteItem(refPath) {
      if (confirm("Are you sure?")) {
        db.ref(refPath).remove();
      }
    }

    function fetchPortfolio() {
      db.ref("portfolio").on("value", snap => {
        portfolioTable.querySelector("tbody").innerHTML = "";
        snap.forEach(child => {
          const d = child.val();
          const row = `
            <tr>
              <td>${d.title}</td>
              <td><img src="${d.image}" width="80"/></td>
              <td><a href="${d.link}" target="_blank">Link</a></td>
              <td>${d.desc}</td>
              <td><button class="btn danger" onclick="deleteItem('portfolio/${child.key}')">Delete</button></td>
            </tr>`;
          portfolioTable.querySelector("tbody").innerHTML += row;
        });
      });
    }

    function fetchPayments() {
      db.ref("payments").on("value", snap => {
        paymentTable.querySelector("tbody").innerHTML = "";
        snap.forEach(child => {
          const d = child.val();
          const row = `
            <tr>
              <td>${d.name}</td>
              <td>${d.email}</td>
              <td>${d.account}</td>
              <td>${d.service}</td>
              <td>${d.message}</td>
              <td><button class="btn danger" onclick="deleteItem('payments/${child.key}')">Delete</button></td>
            </tr>`;
          paymentTable.querySelector("tbody").innerHTML += row;
        });
      });
    }

    function checkRole(uid) {
      db.ref("roles/" + uid).once("value", snap => {
        const role = snap.val()?.role || "viewer";
        userRole.innerText = role;

        // Permissions
        if (role !== "admin" && role !== "editor") {
          portfolio-form-section.style.display = "none";
        }
      });
    }

    auth.onAuthStateChanged(user => {
      if (user) {
        document.getElementById("login-section").style.display = "none";
        document.getElementById("dashboard").classList.remove("hidden");
        userEmail.textContent = user.email;

        if (!user.emailVerified) {
          document.getElementById("verify-email-box").classList.remove("hidden");
        }

        checkRole(user.uid);
        fetchPortfolio();
        fetchPayments();
      }
    });
  </script>
</body>
</html>