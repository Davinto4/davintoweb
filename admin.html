<!DOCTYPE html><html lang="en"><head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Davinto Admin Dashboard</title>
  <link rel="stylesheet" href="style.css">
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js"></script>
</head><body>
  <div id="login-container">
    <h2>Admin Login</h2>
    <input type="email" id="email" placeholder="Email">
    <input type="password" id="password" placeholder="Password">
    <button onclick="login()">Login</button>
    <button onclick="signup()">Signup</button>
    <button onclick="sendVerification()">Resend Verification</button>
    <p id="login-msg"></p>
  </div>  <div id="verify-email-msg" style="display:none;">
    <p>Please verify your email address. Check your inbox or click resend.</p>
  </div>  <div id="admin-panel" style="display:none;">
    <h1>Welcome Admin</h1>
    <button onclick="logout()">Logout</button><div id="approval-panel" style="display:none;">
  <h2>Pending Admin Requests</h2>
  <ul id="pending-list"></ul>
</div>

<h2>Confirmed Payments</h2>
<table id="payments-table">
  <thead>
    <tr><th>Name</th><th>Email</th><th>Account</th><th>Service</th><th>Message</th><th>Actions</th></tr>
  </thead>
  <tbody></tbody>
</table>
<button onclick="exportCSV('payments')">Export Payments CSV</button>

<h2>Portfolio Manager</h2>
<form id="portfolio-form">
  <input type="text" id="title" placeholder="Title" required>
  <input type="text" id="description" placeholder="Description" required>
  <input type="url" id="image" placeholder="Image URL" required>
  <input type="url" id="link" placeholder="Website Link" required>
  <button type="submit">Add Project</button>
</form>

<div id="portfolio-grid"></div>
<button onclick="exportCSV('portfolio')">Export Portfolio CSV</button>

  </div>  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyCxQVcJGHDkzcoVweOsTmQ8oJ0VOXXa4mU",
      authDomain: "davintoweb-payments.firebaseapp.com",
      databaseURL: "https://davintoweb-payments-default-rtdb.firebaseio.com",
      projectId: "davintoweb-payments",
      appId: "1:462234113362:web:e1e7a58e4e27fb56b7eb43"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.database();

    const loginContainer = document.getElementById('login-container');
    const adminPanel = document.getElementById('admin-panel');
    const verifyMsg = document.getElementById('verify-email-msg');
    const loginMsg = document.getElementById('login-msg');
    const approvalPanel = document.getElementById('approval-panel');

    auth.onAuthStateChanged(user => {
      if (user) {
        if (!user.emailVerified) {
          loginContainer.style.display = 'none';
          verifyMsg.style.display = 'block';
        } else {
          db.ref('approvedAdmins/' + user.uid).once('value', snapshot => {
            if (snapshot.exists()) {
              showDashboard(user);
            } else if (user.email === "macdinodavinto@gmail.com") {
              db.ref('approvedAdmins/' + user.uid).set({ role: 'main' });
              showDashboard(user);
            } else {
              db.ref('pendingAdmins/' + user.uid).set({ email: user.email });
              loginMsg.innerText = 'Access pending admin approval.';
              auth.signOut();
            }
          });
        }
      }
    });

    function login() {
      const email = document.getElementById('email').value;
      const pass = document.getElementById('password').value;
      auth.signInWithEmailAndPassword(email, pass).catch(e => loginMsg.innerText = e.message);
    }

    function signup() {
      const email = document.getElementById('email').value;
      const pass = document.getElementById('password').value;
      auth.createUserWithEmailAndPassword(email, pass)
        .then(cred => sendVerification())
        .catch(e => loginMsg.innerText = e.message);
    }

    function sendVerification() {
      const user = auth.currentUser;
      if (user) user.sendEmailVerification().then(() => alert('Verification email sent'));
    }

    function logout() {
      auth.signOut();
      location.reload();
    }

    function showDashboard(user) {
      loginContainer.style.display = 'none';
      verifyMsg.style.display = 'none';
      adminPanel.style.display = 'block';

      if (user.email === 'macdinodavinto@gmail.com') {
        approvalPanel.style.display = 'block';
        db.ref('pendingAdmins').on('value', snap => {
          const list = document.getElementById('pending-list');
          list.innerHTML = '';
          snap.forEach(child => {
            const li = document.createElement('li');
            li.innerHTML = `${child.val().email} <button onclick="approve('${child.key}', '${child.val().email}')">Approve</button> <button onclick="decline('${child.key}')">Decline</button>`;
            list.appendChild(li);
          });
        });
      }

      loadPayments();
      loadPortfolio();

      document.getElementById('portfolio-form').onsubmit = e => {
        e.preventDefault();
        const data = {
          title: document.getElementById('title').value,
          description: document.getElementById('description').value,
          image: document.getElementById('image').value,
          link: document.getElementById('link').value
        };
        db.ref('portfolio').push(data);
        e.target.reset();
      };
    }

    function approve(uid, email) {
      db.ref('approvedAdmins/' + uid).set({ email });
      db.ref('pendingAdmins/' + uid).remove();
    }

    function decline(uid) {
      db.ref('pendingAdmins/' + uid).remove();
    }

    function loadPayments() {
      db.ref('payments').on('value', snap => {
        const tbody = document.querySelector('#payments-table tbody');
        tbody.innerHTML = '';
        snap.forEach(child => {
          const data = child.val();
          const tr = document.createElement('tr');
          tr.innerHTML = `<td>${data.name}</td><td>${data.email}</td><td>${data.account}</td><td>${data.service}</td><td>${data.message}</td>
          <td><button onclick="db.ref('payments/${child.key}').remove()">Delete</button></td>`;
          tbody.appendChild(tr);
        });
      });
    }

    function loadPortfolio() {
      db.ref('portfolio').on('value', snap => {
        const grid = document.getElementById('portfolio-grid');
        grid.innerHTML = '';
        snap.forEach(child => {
          const data = child.val();
          const div = document.createElement('div');
          div.innerHTML = `<h3>${data.title}</h3><p>${data.description}</p><img src="${data.image}" width="100"><a href="${data.link}" target="_blank">Visit</a><br><button onclick="db.ref('portfolio/${child.key}').remove()">Delete</button>`;
          grid.appendChild(div);
        });
      });
    }

    function exportCSV(type) {
      db.ref(type).once('value', snap => {
        let csv = '';
        snap.forEach(child => {
          const row = Object.values(child.val()).join(',');
          csv += row + '\n';
        });
        const blob = new Blob([csv], { type: 'text/csv' });
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = `${type}.csv`;
        a.click();
      });
    }
  </script></body></html>