<!DOCTYPE html>
<html>
<head>
  <title>Admin Dashboard - DavintoWeb</title>
  <meta charset="UTF-8">
  <style>
    body { font-family: Arial; background: #f2f2f2; margin: 0; }
    .container { padding: 20px; }
    .hidden { display: none; }
    .nav { background: #333; color: #fff; padding: 10px; text-align: center; }
    table { width: 100%; border-collapse: collapse; margin-top: 10px; }
    th, td { padding: 10px; border: 1px solid #ccc; }
    button { margin: 5px; }
  </style>
</head>
<body>

<div class="nav">
  <h2>DavintoWeb Admin Panel</h2>
</div>

<div class="container" id="auth-section">
  <h3>Login</h3>
  <input type="email" id="loginEmail" placeholder="Email"><br>
  <input type="password" id="loginPassword" placeholder="Password"><br>
  <button onclick="login()">Login</button>
  <p id="verify-message" style="color:red;"></p>
</div>

<div class="container hidden" id="admin-section">
  <button onclick="logout()">Logout</button>
  <h3>Welcome, <span id="admin-email"></span> (<span id="admin-role"></span>)</h3>
  
  <div>
    <h4>Payment Confirmations</h4>
    <button onclick="exportCSV('payments')">Export Payments</button>
    <table id="paymentsTable">
      <thead><tr><th>Name</th><th>Email</th><th>Account</th><th>Service</th><th>Message</th><th>Actions</th></tr></thead>
      <tbody></tbody>
    </table>
  </div>

  <div>
    <h4>Portfolio</h4>
    <form id="portfolioForm">
      <input type="text" id="title" placeholder="Project Title"><br>
      <input type="url" id="link" placeholder="Project Link"><br>
      <textarea id="desc" placeholder="Description"></textarea><br>
      <button type="submit">Post Portfolio Item</button>
    </form>
    <button onclick="exportCSV('portfolio')">Export Portfolio</button>
    <table id="portfolioTable">
      <thead><tr><th>Title</th><th>Link</th><th>Description</th><th>Actions</th></tr></thead>
      <tbody></tbody>
    </table>
  </div>

  <div>
    <h4>Admin Management</h4>
    <table id="adminRequests">
      <thead><tr><th>Email</th><th>Role</th><th>Status</th><th>Actions</th></tr></thead>
      <tbody></tbody>
    </table>
  </div>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
  import {
    getAuth, onAuthStateChanged, signInWithEmailAndPassword,
    signOut, sendEmailVerification
  } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
  import {
    getDatabase, ref, onValue, set, push, remove, update
  } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";

  const firebaseConfig = {
    apiKey: "AIzaSyBz7fdasuQLxIFLq2TJzPAQrDTJq6h_YT8",
    authDomain: "davintoweb-payments.firebaseapp.com",
    databaseURL: "https://davintoweb-payments-default-rtdb.firebaseio.com",
    projectId: "davintoweb-payments",
    storageBucket: "davintoweb-payments.appspot.com",
    messagingSenderId: "667742200333",
    appId: "1:667742200333:web:cf75f6cef6798eed432b44"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getDatabase(app);

  let currentUserUID = null;
  let currentUserRole = null;

  onAuthStateChanged(auth, (user) => {
    if (user) {
      if (!user.emailVerified) {
        document.getElementById('verify-message').innerHTML = "Email not verified. <button onclick='sendVerify()'>Resend</button>";
        return;
      }
      currentUserUID = user.uid;
      document.getElementById("auth-section").classList.add("hidden");
      document.getElementById("admin-email").textContent = user.email;

      const adminRef = ref(db, "admins/" + currentUserUID);
      onValue(adminRef, (snap) => {
        const data = snap.val();
        if (!data || data.status !== "approved") {
          alert("Access denied or pending approval.");
          logout();
        } else {
          currentUserRole = data.role;
          document.getElementById("admin-role").textContent = currentUserRole;
          document.getElementById("admin-section").classList.remove("hidden");
          loadPayments();
          loadPortfolio();
          if (data.role === "admin") loadAdminRequests();
        }
      });
    }
  });

  function login() {
    const email = document.getElementById("loginEmail").value;
    const password = document.getElementById("loginPassword").value;
    signInWithEmailAndPassword(auth, email, password)
      .catch(err => alert(err.message));
  }

  function logout() {
    signOut(auth);
    location.reload();
  }

  function sendVerify() {
    auth.currentUser.sendEmailVerification()
      .then(() => alert("Verification email sent!"));
  }

  function loadPayments() {
    onValue(ref(db, "payments"), (snap) => {
      const table = document.getElementById("paymentsTable").querySelector("tbody");
      table.innerHTML = "";
      snap.forEach((child) => {
        const d = child.val();
        const row = `<tr>
          <td>${d.name}</td><td>${d.email}</td><td>${d.account}</td>
          <td>${d.service}</td><td>${d.message}</td>
          <td>${currentUserRole === 'admin' ? `<button onclick="removeData('payments','${child.key}')">Delete</button>` : ''}</td>
        </tr>`;
        table.innerHTML += row;
      });
    });
  }

  function loadPortfolio() {
    onValue(ref(db, "portfolio"), (snap) => {
      const table = document.getElementById("portfolioTable").querySelector("tbody");
      table.innerHTML = "";
      snap.forEach((child) => {
        const d = child.val();
        const row = `<tr>
          <td>${d.title}</td><td><a href="${d.link}" target="_blank">Visit</a></td><td>${d.desc}</td>
          <td>${currentUserRole === 'admin' ? `<button onclick="removeData('portfolio','${child.key}')">Delete</button>` : ''}</td>
        </tr>`;
        table.innerHTML += row;
      });
    });
  }

  document.getElementById("portfolioForm").addEventListener("submit", (e) => {
    e.preventDefault();
    const title = document.getElementById("title").value;
    const link = document.getElementById("link").value;
    const desc = document.getElementById("desc").value;
    if (title && link) {
      push(ref(db, "portfolio"), { title, link, desc });
      e.target.reset();
    }
  });

  function removeData(path, key) {
    if (confirm("Delete this entry?")) remove(ref(db, `${path}/${key}`));
  }

  function exportCSV(path) {
    const refPath = ref(db, path);
    onValue(refPath, (snap) => {
      let csv = "";
      snap.forEach((child) => {
        const obj = child.val();
        csv += Object.values(obj).join(",") + "\n";
      });
      const blob = new Blob([csv], { type: "text/csv" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = `${path}.csv`;
      a.click();
    }, { onlyOnce: true });
  }

  function loadAdminRequests() {
    onValue(ref(db, "admins"), (snap) => {
      const table = document.getElementById("adminRequests").querySelector("tbody");
      table.innerHTML = "";
      snap.forEach((child) => {
        const d = child.val();
        if (d.status === "pending") {
          const row = `<tr>
            <td>${d.email}</td><td>${d.role}</td><td>${d.status}</td>
            <td>
              <button onclick="updateStatus('${child.key}', 'approved')">Approve</button>
              <button onclick="updateStatus('${child.key}', 'declined')">Decline</button>
            </td>
          </tr>`;
          table.innerHTML += row;
        }
      });
    });
  }

  function updateStatus(uid, status) {
    update(ref(db, `admins/${uid}`), { status });
  }
</script>
</body>
</html>