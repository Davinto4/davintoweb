<!-- admin.html -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>DavintoWeb Admin Dashboard</title>
  <link rel="stylesheet" href="style.css">
  <style>
    body { font-family: Arial, sans-serif; background: #0f172a; color: white; }
    .hidden { display: none; }
    .container { padding: 20px; max-width: 1000px; margin: auto; }
    .panel, .auth-section { background: #1e293b; padding: 20px; margin-top: 20px; border-radius: 10px; }
    input, textarea, select { width: 100%; margin: 5px 0 10px; padding: 10px; border-radius: 5px; border: none; }
    button { padding: 10px 15px; background: #3b82f6; border: none; border-radius: 5px; color: white; cursor: pointer; }
    table { width: 100%; border-collapse: collapse; margin-top: 20px; }
    table, th, td { border: 1px solid #334155; }
    th, td { padding: 10px; text-align: left; }
    .admin-tag { color: #22c55e; font-weight: bold; }
  </style>
</head>
<body>

<div class="container">

  <h1>DavintoWeb Admin Dashboard</h1>

  <!-- Auth Section -->
  <div id="auth-section" class="auth-section">
    <h2>Login / Signup</h2>
    <input type="email" id="auth-email" placeholder="Email" required>
    <input type="password" id="auth-password" placeholder="Password" required>
    <button onclick="login()">Login</button>
    <button onclick="signup()">Sign Up</button>
    <p id="auth-msg"></p>
    <button onclick="sendVerification()" class="hidden" id="verify-btn">Resend Verification</button>
  </div>

  <!-- Main Panel -->
  <div id="admin-panel" class="panel hidden">
    <h2>Welcome, <span id="admin-email"></span> <span id="admin-role" class="admin-tag"></span></h2>
    <button onclick="logout()">Logout</button>

    <!-- Project Form -->
    <h3>Post New Portfolio Item</h3>
    <form id="project-form">
      <input type="text" id="title" placeholder="Project Title" required>
      <input type="text" id="image" placeholder="Image URL" required>
      <textarea id="description" placeholder="Project Description" required></textarea>
      <input type="url" id="link" placeholder="Project Link" required>
      <button type="submit">Post Project</button>
    </form>

    <!-- Portfolio Table -->
    <h3>Portfolio Projects</h3>
    <table id="portfolio-table">
      <thead>
        <tr><th>Title</th><th>Description</th><th>Image</th><th>Link</th><th>Actions</th></tr>
      </thead>
      <tbody></tbody>
    </table>
    <button onclick="exportCSV('portfolio')">Export Portfolio CSV</button>

    <!-- Payments Table -->
    <h3>Payment Confirmations</h3>
    <table id="payments-table">
      <thead>
        <tr><th>Name</th><th>Email</th><th>Account Used</th><th>Message</th><th>Actions</th></tr>
      </thead>
      <tbody></tbody>
    </table>
    <button onclick="exportCSV('payments')">Export Payments CSV</button>

  </div>
</div>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<script>
  const firebaseConfig = {
    apiKey: "AIzaSyBz7fdasuQLxIFLq2TJzPAQrDTJq6h_YT8",
    authDomain: "davintoweb-payments.firebaseapp.com",
    databaseURL: "https://davintoweb-payments-default-rtdb.firebaseio.com",
    projectId: "davintoweb-payments",
    storageBucket: "davintoweb-payments.appspot.com",
    messagingSenderId: "667742200333",
    appId: "1:667742200333:web:cf75f6cef6798eed432b44"
  };

  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.database();

  const authSection = document.getElementById('auth-section');
  const panel = document.getElementById('admin-panel');
  const emailEl = document.getElementById('auth-email');
  const passEl = document.getElementById('auth-password');
  const msg = document.getElementById('auth-msg');
  const verifyBtn = document.getElementById('verify-btn');

  function login() {
    auth.signInWithEmailAndPassword(emailEl.value, passEl.value)
      .then(() => checkVerification())
      .catch(err => msg.textContent = err.message);
  }

  function signup() {
    auth.createUserWithEmailAndPassword(emailEl.value, passEl.value)
      .then(() => sendVerification())
      .catch(err => msg.textContent = err.message);
  }

  function sendVerification() {
    if (auth.currentUser) {
      auth.currentUser.sendEmailVerification().then(() => {
        msg.textContent = "Verification email sent.";
      });
    }
  }

  function checkVerification() {
    const user = auth.currentUser;
    if (!user.emailVerified) {
      msg.textContent = "Please verify your email.";
      verifyBtn.classList.remove('hidden');
      return;
    }
    showPanel(user);
  }

  function logout() {
    auth.signOut().then(() => {
      panel.classList.add('hidden');
      authSection.classList.remove('hidden');
    });
  }

  function showPanel(user) {
    authSection.classList.add('hidden');
    panel.classList.remove('hidden');
    document.getElementById('admin-email').textContent = user.email;
    getRole(user.uid);
    loadPayments();
    loadPortfolio();
  }

  function getRole(uid) {
    db.ref(`roles/${uid}/role`).once('value', snap => {
      const role = snap.val() || 'viewer';
      document.getElementById('admin-role').textContent = `(${role})`;
    });
  }

  auth.onAuthStateChanged(user => {
    if (user && user.emailVerified) {
      showPanel(user);
    }
  });

  // Project Posting
  document.getElementById('project-form').addEventListener('submit', e => {
    e.preventDefault();
    const data = {
      title: document.getElementById('title').value,
      description: document.getElementById('description').value,
      image: document.getElementById('image').value,
      link: document.getElementById('link').value
    };
    db.ref("portfolio").push(data);
    e.target.reset();
  });

  function loadPortfolio() {
    const table = document.querySelector("#portfolio-table tbody");
    db.ref("portfolio").on("value", snap => {
      table.innerHTML = '';
      snap.forEach(child => {
        const d = child.val();
        table.innerHTML += `
          <tr>
            <td>${d.title}</td>
            <td>${d.description}</td>
            <td><img src="${d.image}" width="60"/></td>
            <td><a href="${d.link}" target="_blank">Visit</a></td>
            <td><button onclick="remove('portfolio','${child.key}')">Delete</button></td>
          </tr>
        `;
      });
    });
  }

  function loadPayments() {
    const table = document.querySelector("#payments-table tbody");
    db.ref("payments").on("value", snap => {
      table.innerHTML = '';
      snap.forEach(child => {
        const d = child.val();
        table.innerHTML += `
          <tr>
            <td>${d.name}</td>
            <td>${d.email}</td>
            <td>${d.account}</td>
            <td>${d.message}</td>
            <td><button onclick="remove('payments','${child.key}')">Delete</button></td>
          </tr>
        `;
      });
    });
  }

  function remove(type, key) {
    if (confirm("Are you sure you want to delete this entry?")) {
      db.ref(`${type}/${key}`).remove();
    }
  }

  function exportCSV(type) {
    const data = [];
    const headers = [];
    db.ref(type).once("value", snap => {
      snap.forEach(child => data.push(child.val()));
      if (data.length === 0) return;
      headers.push(...Object.keys(data[0]));

      const csv = [headers.join(",")];
      data.forEach(row => {
        csv.push(headers.map(h => `"${row[h] || ''}"`).join(","));
      });

      const blob = new Blob([csv.join("\n")], { type: 'text/csv' });
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = `${type}_data.csv`;
      a.click();
    });
  }
</script>

</body>
</html>