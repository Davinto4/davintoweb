<!-- admin.html -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Admin Dashboard â€“ DavintoWeb</title>
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      background: #111;
      color: white;
      padding: 20px;
    }
    .hidden { display: none; }
    table, th, td {
      border: 1px solid white;
      border-collapse: collapse;
      padding: 5px;
    }
    .btn { padding: 6px 12px; margin: 4px; background: #444; border: none; color: white; cursor: pointer; }
    .btn:hover { background: #666; }
    input, select { padding: 5px; margin: 4px; }
    .section { margin-bottom: 30px; }
  </style>
</head>
<body>
  <h2>DavintoWeb Admin Dashboard</h2>

  <!-- LOGIN FORM -->
  <div id="loginSection">
    <input type="email" id="loginEmail" placeholder="Email" />
    <input type="password" id="loginPass" placeholder="Password" />
    <button onclick="login()" class="btn">Login</button>
  </div>

  <!-- VERIFICATION NOTICE -->
  <div id="verifyNotice" class="hidden">
    <p>Please verify your email to access dashboard.</p>
    <button onclick="resendVerification()" class="btn">Resend Email</button>
    <button onclick="logout()" class="btn">Logout</button>
  </div>

  <!-- ADMIN DASHBOARD -->
  <div id="dashboard" class="hidden">

    <p>Welcome <span id="adminEmail"></span> | <span id="adminRole"></span>
    <button onclick="logout()" class="btn">Logout</button></p>

    <!-- Payment Section -->
    <div class="section">
      <h3>Payment Confirmations</h3>
      <button onclick="exportCSV('payments')" class="btn">Export Payments</button>
      <table id="paymentsTable">
        <thead>
          <tr><th>Name</th><th>Email</th><th>Account</th><th>Message</th><th>Action</th></tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <!-- Portfolio Section -->
    <div class="section">
      <h3>Portfolio Projects</h3>
      <form onsubmit="addProject(event)">
        <input type="text" id="projectTitle" placeholder="Title" required />
        <input type="text" id="projectURL" placeholder="URL" required />
        <input type="text" id="projectImage" placeholder="Image Link" required />
        <button type="submit" class="btn">Add Project</button>
      </form>
      <button onclick="exportCSV('portfolio')" class="btn">Export Portfolio</button>
      <table id="portfolioTable">
        <thead>
          <tr><th>Title</th><th>URL</th><th>Image</th><th>Action</th></tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <!-- Firebase + Script -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyBz7fdasuQLxIFLq2TJzPAQrDTJq6h_YT8",
      authDomain: "davintoweb-payments.firebaseapp.com",
      databaseURL: "https://davintoweb-payments-default-rtdb.firebaseio.com",
      projectId: "davintoweb-payments",
      storageBucket: "davintoweb-payments.appspot.com",
      messagingSenderId: "667742200333",
      appId: "1:667742200333:web:cf75f6cef6798eed432b44"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.database();

    const loginSection = document.getElementById("loginSection");
    const verifyNotice = document.getElementById("verifyNotice");
    const dashboard = document.getElementById("dashboard");

    function login() {
      const email = loginEmail.value;
      const pass = loginPass.value;
      auth.signInWithEmailAndPassword(email, pass)
        .catch(e => alert("Login failed: " + e.message));
    }

    function logout() {
      auth.signOut();
    }

    function resendVerification() {
      const user = auth.currentUser;
      if (user) {
        user.sendEmailVerification()
          .then(() => alert("Verification email sent."))
          .catch(err => alert(err.message));
      }
    }

    function checkRole(uid) {
      return db.ref("admins/" + uid + "/role").once("value").then(snap => snap.val() || "viewer");
    }

    auth.onAuthStateChanged(async user => {
      if (user) {
        const verified = user.emailVerified;
        if (!verified) {
          loginSection.style.display = "none";
          verifyNotice.classList.remove("hidden");
          dashboard.classList.add("hidden");
          return;
        }
        document.getElementById("adminEmail").textContent = user.email;
        const role = await checkRole(user.uid);
        document.getElementById("adminRole").textContent = role;

        loginSection.style.display = "none";
        verifyNotice.classList.add("hidden");
        dashboard.classList.remove("hidden");

        loadPayments();
        loadPortfolio(role);
      } else {
        loginSection.style.display = "block";
        verifyNotice.classList.add("hidden");
        dashboard.classList.add("hidden");
      }
    });

    function loadPayments() {
      const tbody = document.querySelector("#paymentsTable tbody");
      tbody.innerHTML = "";
      db.ref("payments").on("value", snap => {
        tbody.innerHTML = "";
        snap.forEach(child => {
          const data = child.val();
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td>${data.name}</td>
            <td>${data.email}</td>
            <td>${data.account}</td>
            <td>${data.message}</td>
            <td><button class="btn" onclick="deleteEntry('payments','${child.key}')">Delete</button></td>`;
          tbody.appendChild(tr);
        });
      });
    }

    function loadPortfolio(role) {
      const tbody = document.querySelector("#portfolioTable tbody");
      tbody.innerHTML = "";
      db.ref("portfolio").on("value", snap => {
        tbody.innerHTML = "";
        snap.forEach(child => {
          const data = child.val();
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td>${data.title}</td>
            <td><a href="${data.url}" target="_blank">${data.url}</a></td>
            <td><img src="${data.image}" width="80"/></td>
            <td>
              <button class="btn" onclick="deleteEntry('portfolio','${child.key}')">Delete</button>
            </td>`;
          tbody.appendChild(tr);
        });
      });
    }

    function addProject(e) {
      e.preventDefault();
      const title = projectTitle.value;
      const url = projectURL.value;
      const image = projectImage.value;
      const key = db.ref("portfolio").push().key;
      db.ref("portfolio/" + key).set({ title, url, image })
        .then(() => {
          alert("Project added!");
          projectTitle.value = projectURL.value = projectImage.value = "";
        });
    }

    function deleteEntry(type, key) {
      if (confirm("Are you sure?")) {
        db.ref(type + "/" + key).remove();
      }
    }

    function exportCSV(section) {
      db.ref(section).once("value", snap => {
        let csv = '';
        snap.forEach(child => {
          const data = child.val();
          csv += Object.values(data).join(",") + "\n";
        });
        const blob = new Blob([csv], { type: 'text/csv' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = `${section}.csv`;
        a.click();
      });
    }
  </script>
</body>
</html>