<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Davinto Admin Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="style.css" />
  <script src="https://www.gstatic.com/firebasejs/9.6.11/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.11/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.11/firebase-database-compat.js"></script>
</head>
<body>
  <div id="auth-section" style="display:none;">
    <h2>Admin Login</h2>
    <input type="email" id="loginEmail" placeholder="Email" />
    <input type="password" id="loginPassword" placeholder="Password" />
    <button onclick="login()">Login</button>
    <button onclick="register()">Register</button>
  </div>

  <div id="verify-section" style="display:none;">
    <h3>Please verify your email before continuing.</h3>
    <button onclick="resendVerification()">Resend Verification Email</button>
    <button onclick="logout()">Logout</button>
  </div>

  <div id="admin-panel" style="display:none;">
    <h1>Welcome, Admin</h1>
    <button onclick="logout()">Logout</button>

    <section>
      <h2>Add Portfolio Project</h2>
      <input type="text" id="projectTitle" placeholder="Project Title" />
      <input type="text" id="projectImage" placeholder="Image URL" />
      <textarea id="projectDesc" placeholder="Project Description"></textarea>
      <button onclick="addProject()">Post Project</button>
    </section>

    <section>
      <h2>Portfolio Items</h2>
      <table id="portfolioTable" border="1">
        <thead>
          <tr><th>Title</th><th>Description</th><th>Image</th><th>Actions</th></tr>
        </thead>
        <tbody></tbody>
      </table>
      <button onclick="exportCSV('portfolio')">Export Portfolio CSV</button>
    </section>

    <section>
      <h2>Payment Confirmations</h2>
      <table id="paymentsTable" border="1">
        <thead>
          <tr><th>Name</th><th>Email</th><th>Account</th><th>Service</th><th>Message</th><th>Actions</th></tr>
        </thead>
        <tbody></tbody>
      </table>
      <button onclick="exportCSV('payments')">Export Payments CSV</button>
    </section>
  </div>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyBz7fdasuQLxIFLq2TJzPAQrDTJq6h_YT8",
      authDomain: "davintoweb-payments.firebaseapp.com",
      databaseURL: "https://davintoweb-payments-default-rtdb.firebaseio.com",
      projectId: "davintoweb-payments",
      storageBucket: "davintoweb-payments.appspot.com",
      messagingSenderId: "667742200333",
      appId: "1:667742200333:web:cf75f6cef6798eed432b44"
    };

    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.database();

    const authSection = document.getElementById("auth-section");
    const verifySection = document.getElementById("verify-section");
    const adminPanel = document.getElementById("admin-panel");

    auth.onAuthStateChanged(user => {
      if (!user) {
        authSection.style.display = "block";
        verifySection.style.display = "none";
        adminPanel.style.display = "none";
      } else if (!user.emailVerified) {
        authSection.style.display = "none";
        verifySection.style.display = "block";
        adminPanel.style.display = "none";
      } else {
        authSection.style.display = "none";
        verifySection.style.display = "none";
        adminPanel.style.display = "block";
        loadPortfolio();
        loadPayments();
      }
    });

    function login() {
      const email = document.getElementById("loginEmail").value;
      const password = document.getElementById("loginPassword").value;
      auth.signInWithEmailAndPassword(email, password)
        .catch(err => alert("Login error: " + err.message));
    }

    function register() {
      const email = document.getElementById("loginEmail").value;
      const password = document.getElementById("loginPassword").value;
      auth.createUserWithEmailAndPassword(email, password)
        .then(userCredential => {
          userCredential.user.sendEmailVerification();
          alert("Verification email sent. Please check your inbox.");
        })
        .catch(err => alert("Registration error: " + err.message));
    }

    function logout() {
      auth.signOut();
    }

    function resendVerification() {
      auth.currentUser.sendEmailVerification()
        .then(() => alert("Verification email sent."))
        .catch(err => alert("Error: " + err.message));
    }

    function addProject() {
      const title = document.getElementById("projectTitle").value;
      const image = document.getElementById("projectImage").value;
      const desc = document.getElementById("projectDesc").value;
      const id = Date.now();
      db.ref("portfolio/" + id).set({ title, image, desc });
    }

    function loadPortfolio() {
      const tbody = document.querySelector("#portfolioTable tbody");
      tbody.innerHTML = "";
      db.ref("portfolio").on("value", snapshot => {
        tbody.innerHTML = "";
        snapshot.forEach(child => {
          const item = child.val();
          const row = document.createElement("tr");
          row.innerHTML = `
            <td>${item.title}</td>
            <td>${item.desc}</td>
            <td><img src="${item.image}" width="80"/></td>
            <td>
              <button onclick="editProject('${child.key}')">Edit</button>
              <button onclick="deleteProject('${child.key}')">Delete</button>
            </td>`;
          tbody.appendChild(row);
        });
      });
    }

    function editProject(key) {
      const newTitle = prompt("New Title:");
      const newDesc = prompt("New Description:");
      const newImage = prompt("New Image URL:");
      db.ref("portfolio/" + key).update({ title: newTitle, desc: newDesc, image: newImage });
    }

    function deleteProject(key) {
      if (confirm("Are you sure?")) {
        db.ref("portfolio/" + key).remove();
      }
    }

    function loadPayments() {
      const tbody = document.querySelector("#paymentsTable tbody");
      db.ref("payments").on("value", snapshot => {
        tbody.innerHTML = "";
        snapshot.forEach(child => {
          const data = child.val();
          const row = document.createElement("tr");
          row.innerHTML = `
            <td>${data.name}</td>
            <td>${data.email}</td>
            <td>${data.account}</td>
            <td>${data.service}</td>
            <td>${data.message}</td>
            <td><button onclick="deletePayment('${child.key}')">Delete</button></td>
          `;
          tbody.appendChild(row);
        });
      });
    }

    function deletePayment(key) {
      if (confirm("Delete this payment?")) {
        db.ref("payments/" + key).remove();
      }
    }

    function exportCSV(type) {
      let data = [];
      let headers = [];
      if (type === "portfolio") {
        headers = ["Title", "Description", "Image"];
        db.ref("portfolio").once("value", snapshot => {
          snapshot.forEach(child => {
            const item = child.val();
            data.push([item.title, item.desc, item.image]);
          });
          downloadCSV(headers, data, "portfolio.csv");
        });
      } else {
        headers = ["Name", "Email", "Account", "Service", "Message"];
        db.ref("payments").once("value", snapshot => {
          snapshot.forEach(child => {
            const item = child.val();
            data.push([item.name, item.email, item.account, item.service, item.message]);
          });
          downloadCSV(headers, data, "payments.csv");
        });
      }
    }

    function downloadCSV(headers, rows, filename) {
      let csvContent = "data:text/csv;charset=utf-8," + [headers, ...rows].map(e => e.join(",")).join("\n");
      const encodedUri = encodeURI(csvContent);
      const link = document.createElement("a");
      link.setAttribute("href", encodedUri);
      link.setAttribute("download", filename);
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    }
  </script>
</body>
</html>