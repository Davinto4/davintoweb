<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Admin Dashboard - DavintoWeb</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body { font-family: sans-serif; background: #111; color: white; margin: 0; padding: 0; }
    header { background: #222; padding: 1rem; text-align: center; font-size: 1.4rem; font-weight: bold; }
    .hidden { display: none; }
    .container { padding: 1rem; }
    input, textarea, button, select {
      margin: 0.4rem 0; padding: 0.5rem; width: 100%;
      background: #222; color: white; border: 1px solid #444;
    }
    table { width: 100%; border-collapse: collapse; margin-top: 1rem; }
    th, td { border: 1px solid #444; padding: 0.5rem; text-align: left; }
    .admin-btns button { margin-right: 0.5rem; }
  </style>
</head>
<body>

<header>Admin Panel - DavintoWeb</header>

<div id="login-section" class="container">
  <h3>Admin Login</h3>
  <input type="email" id="email" placeholder="Email">
  <input type="password" id="password" placeholder="Password">
  <button onclick="login()">Login</button>
</div>

<div id="admin-section" class="container hidden">
  <p id="welcomeMsg"></p>
  <button onclick="logout()">Logout</button>
  <button onclick="resendVerification()">Resend Email Verification</button>

  <h3>Post New Portfolio Project</h3>
  <input id="projectTitle" placeholder="Title">
  <input id="projectImage" placeholder="Image URL">
  <textarea id="projectDesc" placeholder="Description"></textarea>
  <button onclick="postPortfolio()">Post Project</button>

  <h3>Portfolio Projects</h3>
  <div id="portfolio"></div>

  <h3>Payment Confirmations</h3>
  <button onclick="exportPaymentsToCSV()">Export Payments as CSV</button>
  <div id="payments"></div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getAuth, signInWithEmailAndPassword, signOut, sendEmailVerification, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
import { getDatabase, ref, push, set, onValue, remove, update } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyBz7fdasuQLxIFLq2TJzPAQrDTJq6h_YT8",
  authDomain: "davintoweb-payments.firebaseapp.com",
  databaseURL: "https://davintoweb-payments-default-rtdb.firebaseio.com",
  projectId: "davintoweb-payments",
  storageBucket: "davintoweb-payments.appspot.com",
  messagingSenderId: "667742200333",
  appId: "1:667742200333:web:cf75f6cef6798eed432b44"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getDatabase(app);

// Login
window.login = () => {
  const email = document.getElementById("email").value;
  const pass = document.getElementById("password").value;
  signInWithEmailAndPassword(auth, email, pass)
    .then(userCred => {
      const user = userCred.user;
      if (!user.emailVerified) {
        alert("Email not verified. Please check your inbox.");
      }
    })
    .catch(err => alert(err.message));
};

// Logout
window.logout = () => signOut(auth);

// Resend Verification
window.resendVerification = () => {
  if (auth.currentUser && !auth.currentUser.emailVerified) {
    sendEmailVerification(auth.currentUser)
      .then(() => alert("Verification email sent."))
      .catch(e => alert(e.message));
  }
};

// Auth check
onAuthStateChanged(auth, user => {
  if (user && user.emailVerified) {
    document.getElementById("login-section").classList.add("hidden");
    document.getElementById("admin-section").classList.remove("hidden");
    document.getElementById("welcomeMsg").textContent = `Welcome, ${user.email}`;
    loadPortfolio();
    loadPayments();
  } else {
    document.getElementById("login-section").classList.remove("hidden");
    document.getElementById("admin-section").classList.add("hidden");
  }
});

// Post Project
window.postPortfolio = () => {
  const title = document.getElementById("projectTitle").value;
  const image = document.getElementById("projectImage").value;
  const desc = document.getElementById("projectDesc").value;
  const id = push(ref(db, "portfolio")).key;
  set(ref(db, `portfolio/${id}`), { id, title, image, desc });
  alert("Project posted.");
};

// Load Projects
function loadPortfolio() {
  const portfolioDiv = document.getElementById("portfolio");
  onValue(ref(db, "portfolio"), snap => {
    portfolioDiv.innerHTML = "";
    snap.forEach(child => {
      const p = child.val();
      const card = document.createElement("div");
      card.innerHTML = `
        <h4>${p.title}</h4>
        <img src="${p.image}" width="100">
        <p>${p.desc}</p>
        <div class="admin-btns">
          <button onclick="editPortfolio('${p.id}')">Edit</button>
          <button onclick="deletePortfolio('${p.id}')">Delete</button>
        </div>
        <hr>`;
      portfolioDiv.appendChild(card);
    });
  });
}

window.deletePortfolio = (id) => {
  if (confirm("Delete this project?")) {
    remove(ref(db, `portfolio/${id}`));
  }
};

window.editPortfolio = (id) => {
  const newTitle = prompt("New Title:");
  const newDesc = prompt("New Description:");
  const newImg = prompt("New Image URL:");
  update(ref(db, `portfolio/${id}`), { title: newTitle, desc: newDesc, image: newImg });
};

// Payments
function loadPayments() {
  const paymentsDiv = document.getElementById("payments");
  onValue(ref(db, "confirmations"), snap => {
    paymentsDiv.innerHTML = "";
    snap.forEach(child => {
      const p = child.val();
      paymentsDiv.innerHTML += `
        <p><strong>${p.name}</strong> - ${p.email} - ${p.account}<br>
        ${p.message} <br>
        <button onclick="deletePayment('${child.key}')">Delete</button></p><hr>`;
    });
  });
}

window.deletePayment = (key) => {
  if (confirm("Delete this payment?")) {
    remove(ref(db, `confirmations/${key}`));
  }
};

// CSV Export
window.exportPaymentsToCSV = () => {
  onValue(ref(db, "confirmations"), snap => {
    let csv = "Name,Email,Account,Message\n";
    snap.forEach(child => {
      const p = child.val();
      csv += `"${p.name}","${p.email}","${p.account}","${p.message}"\n`;
    });
    const blob = new Blob([csv], { type: "text/csv" });
    const link = document.createElement("a");
    link.href = URL.createObjectURL(blob);
    link.download = "payments.csv";
    link.click();
  });
};
</script>

</body>
</html>