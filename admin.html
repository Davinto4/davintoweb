<!-- admin.html -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Admin Dashboard</title>
  <link rel="stylesheet" href="style.css" />
  <script src="https://www.gstatic.com/firebasejs/10.5.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.5.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.5.2/firebase-database-compat.js"></script>
</head>
<body>
  <div id="loginSection" style="display: none;">
    <h2>Admin Login</h2>
    <input type="email" id="email" placeholder="Email"><br>
    <input type="password" id="password" placeholder="Password"><br>
    <button onclick="login()">Login</button><br><br>
    <button onclick="register()">Register</button><br>
    <button onclick="sendVerificationEmail()">Resend Verification Email</button>
  </div>

  <div id="adminDashboard" style="display: none;">
    <h1>Welcome Admin</h1>
    <button onclick="logout()">Logout</button>
    <h2>Submit New Portfolio Item</h2>
    <input id="title" placeholder="Title">
    <input id="description" placeholder="Description">
    <input id="image" placeholder="Image URL">
    <button onclick="submitPortfolio()">Add Project</button>

    <h2>Portfolio List</h2>
    <div id="portfolioList"></div>
    <button onclick="exportPortfolioCSV()">Export Portfolio CSV</button>

    <h2>Payments</h2>
    <div id="paymentList"></div>
    <button onclick="exportPaymentsCSV()">Export Payments CSV</button>
  </div>

<script>
  const firebaseConfig = {
    apiKey: "AIzaSyBz7fdasuQLxIFLq2TJzPAQrDTJq6h_YT8",
    authDomain: "davintoweb-payments.firebaseapp.com",
    databaseURL: "https://davintoweb-payments-default-rtdb.firebaseio.com",
    projectId: "davintoweb-payments",
    storageBucket: "davintoweb-payments.appspot.com",
    messagingSenderId: "667742200333",
    appId: "1:667742200333:web:cf75f6cef6798eed432b44"
  };

  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.database();

  let currentUserRole = null;

  function login() {
    const email = emailInput.value;
    const password = passwordInput.value;
    auth.signInWithEmailAndPassword(email, password)
      .then(userCredential => {
        const user = userCredential.user;
        if (!user.emailVerified) {
          alert("Please verify your email before accessing the dashboard.");
        } else {
          checkRole(user.uid);
        }
      })
      .catch(e => alert(e.message));
  }

  function register() {
    const email = emailInput.value;
    const password = passwordInput.value;
    auth.createUserWithEmailAndPassword(email, password)
      .then(userCredential => {
        sendVerificationEmail();
        alert("Account created. Please verify your email.");
        // Default role assigned in DB
        db.ref("roles/" + userCredential.user.uid).set("viewer");
      })
      .catch(e => alert(e.message));
  }

  function sendVerificationEmail() {
    const user = auth.currentUser;
    if (user) {
      user.sendEmailVerification().then(() => {
        alert("Verification email sent to " + user.email);
      });
    } else {
      alert("You must log in first");
    }
  }

  function logout() {
    auth.signOut().then(() => {
      location.reload();
    });
  }

  function checkRole(uid) {
    db.ref("roles/" + uid).once("value").then(snapshot => {
      const role = snapshot.val();
      currentUserRole = role || "viewer";
      if (role === "admin" || role === "editor") {
        showDashboard();
      } else {
        alert("You do not have permission to access the dashboard.");
      }
    });
  }

  function showDashboard() {
    loginSection.style.display = "none";
    adminDashboard.style.display = "block";
    loadPayments();
    loadPortfolio();
  }

  function submitPortfolio() {
    if (currentUserRole !== "admin" && currentUserRole !== "editor") {
      alert("You don't have permission.");
      return;
    }
    const portfolio = {
      title: title.value,
      description: description.value,
      image: image.value
    };
    db.ref("portfolio").push(portfolio);
    alert("Portfolio project added.");
  }

  function loadPortfolio() {
    portfolioList.innerHTML = "";
    db.ref("portfolio").on("value", snap => {
      snap.forEach(child => {
        const item = child.val();
        const key = child.key;
        portfolioList.innerHTML += `
          <div>
            <strong>${item.title}</strong> - ${item.description}
            <br><img src="${item.image}" width="100">
            ${currentUserRole === 'admin' ? `
              <button onclick="editPortfolio('${key}')">Edit</button>
              <button onclick="deletePortfolio('${key}')">Delete</button>
            ` : ''}
            <hr>
          </div>`;
      });
    });
  }

  function editPortfolio(key) {
    const newTitle = prompt("New title:");
    const newDesc = prompt("New description:");
    db.ref("portfolio/" + key).update({ title: newTitle, description: newDesc });
  }

  function deletePortfolio(key) {
    db.ref("portfolio/" + key).remove();
  }

  function loadPayments() {
    paymentList.innerHTML = "";
    db.ref("payments").on("value", snap => {
      snap.forEach(child => {
        const item = child.val();
        const key = child.key;
        paymentList.innerHTML += `
          <div>
            <strong>${item.name}</strong> - ${item.email} - ${item.account}
            ${currentUserRole === 'admin' ? `
              <button onclick="deletePayment('${key}')">Delete</button>
            ` : ''}
            <hr>
          </div>`;
      });
    });
  }

  function deletePayment(key) {
    db.ref("payments/" + key).remove();
  }

  function exportPortfolioCSV() {
    db.ref("portfolio").once("value", snap => {
      let csv = "Title,Description,Image\n";
      snap.forEach(child => {
        const item = child.val();
        csv += `${item.title},${item.description},${item.image}\n`;
      });
      downloadCSV(csv, "portfolio.csv");
    });
  }

  function exportPaymentsCSV() {
    db.ref("payments").once("value", snap => {
      let csv = "Name,Email,Account,Message\n";
      snap.forEach(child => {
        const item = child.val();
        csv += `${item.name},${item.email},${item.account},${item.message || ''}\n`;
      });
      downloadCSV(csv, "payments.csv");
    });
  }

  function downloadCSV(data, filename) {
    const blob = new Blob([data], { type: 'text/csv' });
    const link = document.createElement("a");
    link.href = URL.createObjectURL(blob);
    link.download = filename;
    link.click();
  }

  auth.onAuthStateChanged(user => {
    if (user && user.emailVerified) {
      checkRole(user.uid);
    } else {
      loginSection.style.display = "block";
    }
  });
</script>
</body>
</html>