<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Admin Dashboard</title>
  <link rel="stylesheet" href="style.css" />
  <style>
    body { font-family: Arial, sans-serif; background: #f5f5f5; padding: 1rem; }
    .hidden { display: none; }
    .dashboard { margin-top: 2rem; }
    .form-group { margin: 0.5rem 0; }
    .form-group input { padding: 0.5rem; width: 100%; }
    .btn { padding: 0.5rem 1rem; margin: 0.3rem; cursor: pointer; }
    table { width: 100%; border-collapse: collapse; margin-top: 1rem; }
    th, td { border: 1px solid #ccc; padding: 0.5rem; text-align: left; }
    .admin-form, .login-box { background: white; padding: 1rem; border-radius: 8px; margin-bottom: 1rem; }
    .export-btn { background: green; color: white; }
  </style>
</head>
<body>

  <div id="authSection" class="login-box">
    <h2>Admin Login / Signup</h2>
    <div class="form-group">
      <input type="email" id="email" placeholder="Email" />
    </div>
    <div class="form-group">
      <input type="password" id="password" placeholder="Password" />
    </div>
    <button class="btn" onclick="login()">Login</button>
    <button class="btn" onclick="signup()">Sign Up</button>
    <button class="btn" onclick="resendVerification()">Resend Verification</button>
    <p id="authMessage"></p>
  </div>

  <div id="dashboard" class="dashboard hidden">
    <h2>Welcome, <span id="userEmail"></span> (<span id="userRole"></span>)</h2>
    <button class="btn" onclick="logout()">Logout</button>

    <div id="portfolioSection" class="admin-form hidden">
      <h3>Add Portfolio Item</h3>
      <div class="form-group"><input type="text" id="projectTitle" placeholder="Project Title" /></div>
      <div class="form-group"><input type="text" id="projectURL" placeholder="Project URL" /></div>
      <div class="form-group"><input type="text" id="projectImage" placeholder="Image URL" /></div>
      <button class="btn" onclick="addPortfolio()">Post Portfolio</button>
    </div>

    <h3>Payment Confirmations</h3>
    <button class="btn export-btn" onclick="exportCSV('payments')">Export CSV</button>
    <table id="paymentsTable"><thead><tr><th>Name</th><th>Email</th><th>Account</th><th>Message</th><th>Action</th></tr></thead><tbody></tbody></table>

    <h3>Portfolio Projects</h3>
    <button class="btn export-btn" onclick="exportCSV('portfolio')">Export CSV</button>
    <table id="portfolioTable"><thead><tr><th>Title</th><th>URL</th><th>Image</th><th>Action</th></tr></thead><tbody></tbody></table>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-app.js";
    import {
      getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword,
      sendEmailVerification, signOut, onAuthStateChanged
    } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-auth.js";
    import {
      getDatabase, ref, push, onValue, set, get, child, remove, update
    } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBz7fdasuQLxIFLq2TJzPAQrDTJq6h_YT8",
      authDomain: "davintoweb-payments.firebaseapp.com",
      databaseURL: "https://davintoweb-payments-default-rtdb.firebaseio.com",
      projectId: "davintoweb-payments",
      storageBucket: "davintoweb-payments.appspot.com",
      messagingSenderId: "667742200333",
      appId: "1:667742200333:web:cf75f6cef6798eed432b44"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getDatabase(app);
    const dbRef = ref(db);

    const adminEmail = "macdinodavinto@gmail.com";
    const adminPassword = "08022664487@Mac";

    const emailInput = document.getElementById("email");
    const passwordInput = document.getElementById("password");

    function login() {
      const email = emailInput.value;
      const password = passwordInput.value;
      signInWithEmailAndPassword(auth, email, password)
        .catch(err => alert("Login error: " + err.message));
    }

    function signup() {
      const email = emailInput.value;
      const password = passwordInput.value;
      createUserWithEmailAndPassword(auth, email, password)
        .then(userCred => {
          sendEmailVerification(userCred.user);
          alert("Verification email sent.");
          // Default role as viewer unless admin
          const role = (email === adminEmail) ? "admin" : "viewer";
          set(ref(db, "roles/" + userCred.user.uid), { role });
        })
        .catch(err => alert("Signup error: " + err.message));
    }

    function resendVerification() {
      if (auth.currentUser) {
        sendEmailVerification(auth.currentUser).then(() => {
          alert("Verification email sent.");
        });
      }
    }

    function logout() {
      signOut(auth);
      document.getElementById("dashboard").classList.add("hidden");
      document.getElementById("authSection").classList.remove("hidden");
    }

    onAuthStateChanged(auth, user => {
      if (user) {
        if (!user.emailVerified) {
          alert("Verify your email first.");
          logout();
          return;
        }
        document.getElementById("authSection").classList.add("hidden");
        document.getElementById("dashboard").classList.remove("hidden");
        document.getElementById("userEmail").textContent = user.email;

        // Get role
        get(child(dbRef, `roles/${user.uid}`)).then(snapshot => {
          let role = "viewer";
          if (snapshot.exists()) {
            role = snapshot.val().role;
          }
          document.getElementById("userRole").textContent = role;
          if (role === "admin" || role === "editor") {
            document.getElementById("portfolioSection").classList.remove("hidden");
          }

          loadPayments(role);
          loadPortfolio(role);
        });
      }
    });

    function loadPayments(role) {
      onValue(ref(db, "payments"), snapshot => {
        const table = document.querySelector("#paymentsTable tbody");
        table.innerHTML = "";
        snapshot.forEach(child => {
          const data = child.val();
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td>${data.name}</td>
            <td>${data.email}</td>
            <td>${data.account}</td>
            <td>${data.message}</td>
            <td>
              ${role === "admin" ? `<button onclick="removePayment('${child.key}')">Delete</button>` : "No Access"}
            </td>`;
          table.appendChild(tr);
        });
      });
    }

    function removePayment(id) {
      remove(ref(db, "payments/" + id));
    }

    function addPortfolio() {
      const title = document.getElementById("projectTitle").value;
      const url = document.getElementById("projectURL").value;
      const image = document.getElementById("projectImage").value;
      push(ref(db, "portfolio"), { title, url, image });
    }

    function loadPortfolio(role) {
      onValue(ref(db, "portfolio"), snapshot => {
        const table = document.querySelector("#portfolioTable tbody");
        table.innerHTML = "";
        snapshot.forEach(child => {
          const data = child.val();
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td>${data.title}</td>
            <td><a href="${data.url}" target="_blank">${data.url}</a></td>
            <td><img src="${data.image}" width="80"/></td>
            <td>
              ${role === "admin" ? `<button onclick="removePortfolio('${child.key}')">Delete</button>` : "No Access"}
            </td>`;
          table.appendChild(tr);
        });
      });
    }

    function removePortfolio(id) {
      remove(ref(db, "portfolio/" + id));
    }

    window.removePayment = removePayment;
    window.removePortfolio = removePortfolio;

    window.exportCSV = function (type) {
      const path = type === "payments" ? "payments" : "portfolio";
      get(ref(db, path)).then(snapshot => {
        if (snapshot.exists()) {
          let csv = "";
          snapshot.forEach(child => {
            const data = child.val();
            csv += Object.values(data).join(",") + "\n";
          });
          const blob = new Blob([csv], { type: "text/csv" });
          const link = document.createElement("a");
          link.href = URL.createObjectURL(blob);
          link.download = `${path}.csv`;
          link.click();
        }
      });
    }
  </script>
</body>
</html>