<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Admin Dashboard - DavintoWeb</title>
  <link rel="stylesheet" href="style.css" />
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
  <style>
    body { font-family: Arial, sans-serif; margin: 0; background: #111; color: white; }
    nav { background: #222; padding: 10px; text-align: center; }
    nav button { margin: 0 5px; padding: 10px 20px; cursor: pointer; }
    .hidden { display: none; }
    #admin-section { padding: 20px; }
    table { width: 100%; border-collapse: collapse; margin: 20px 0; background: #222; }
    th, td { padding: 10px; border: 1px solid #444; }
    input, textarea, select { width: 100%; padding: 10px; margin-bottom: 10px; background: #333; color: white; border: none; }
    .form-group { margin-bottom: 15px; }
    .btn { background: #007bff; color: white; padding: 10px 15px; border: none; cursor: pointer; }
    .btn-danger { background: crimson; }
    .btn-warning { background: orange; }
    .verified-banner { background: green; padding: 10px; color: white; text-align: center; }
    .unverified-banner { background: darkred; padding: 10px; color: white; text-align: center; }
  </style>
</head>
<body>
  <nav>
    <button onclick="showTab('payments')">Payment Dashboard</button>
    <button onclick="showTab('portfolio')">Manage Portfolio</button>
    <button onclick="exportCSV('payments')">Export Payments CSV</button>
    <button onclick="exportCSV('portfolio')">Export Portfolio CSV</button>
    <button onclick="logout()">Logout</button>
  </nav>

  <div id="login-section">
    <h2>Admin Login</h2>
    <input type="email" id="login-email" placeholder="Email" required>
    <input type="password" id="login-password" placeholder="Password" required>
    <button class="btn" onclick="login()">Login</button>
  </div>

  <div id="verify-banner" class="hidden">
    <p class="unverified-banner">Please verify your email to continue. <button onclick="resendVerification()">Resend Verification</button></p>
  </div>

  <div id="admin-section" class="hidden">
    <h2>Welcome <span id="admin-role"></span></h2>

    <!-- Payments -->
    <div id="payments" class="tab">
      <h3>Confirmed Payments</h3>
      <table id="payments-table">
        <thead>
          <tr><th>Name</th><th>Email</th><th>Account</th><th>Message</th><th>Date</th><th>Action</th></tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <!-- Portfolio -->
    <div id="portfolio" class="tab hidden">
      <h3>Post New Portfolio</h3>
      <div class="form-group">
        <input type="text" id="project-title" placeholder="Title" />
        <textarea id="project-desc" placeholder="Description"></textarea>
        <input type="url" id="project-link" placeholder="Project Link" />
        <button class="btn" onclick="postPortfolio()">Post Project</button>
      </div>

      <h3>All Portfolio Projects</h3>
      <table id="portfolio-table">
        <thead>
          <tr><th>Title</th><th>Description</th><th>Link</th><th>Action</th></tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyBz7fdasuQLxIFLq2TJzPAQrDTJq6h_YT8",
      authDomain: "davintoweb-payments.firebaseapp.com",
      databaseURL: "https://davintoweb-payments-default-rtdb.firebaseio.com",
      projectId: "davintoweb-payments",
      storageBucket: "davintoweb-payments.appspot.com",
      messagingSenderId: "667742200333",
      appId: "1:667742200333:web:cf75f6cef6798eed432b44"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.database();

    const loginSection = document.getElementById('login-section');
    const adminSection = document.getElementById('admin-section');
    const verifyBanner = document.getElementById('verify-banner');

    auth.onAuthStateChanged(user => {
      if (user) {
        if (!user.emailVerified) {
          verifyBanner.classList.remove('hidden');
          adminSection.classList.add('hidden');
          return;
        }
        verifyBanner.classList.add('hidden');
        loginSection.classList.add('hidden');
        adminSection.classList.remove('hidden');
        loadPayments();
        loadPortfolio();
        setRole(user.uid);
      } else {
        loginSection.classList.remove('hidden');
        adminSection.classList.add('hidden');
      }
    });

    function login() {
      const email = document.getElementById('login-email').value;
      const password = document.getElementById('login-password').value;
      auth.signInWithEmailAndPassword(email, password)
        .catch(err => alert(err.message));
    }

    function logout() {
      auth.signOut();
    }

    function resendVerification() {
      auth.currentUser.sendEmailVerification().then(() => {
        alert('Verification email sent!');
      });
    }

    function setRole(uid) {
      const roles = {
        "nQ33hEuucMcT39OVyzWivhSpdJz1": "Admin"
      };
      document.getElementById("admin-role").textContent = roles[uid] || "Viewer";
    }

    function showTab(tab) {
      document.querySelectorAll('.tab').forEach(el => el.classList.add('hidden'));
      document.getElementById(tab).classList.remove('hidden');
    }

    function loadPayments() {
      const tbody = document.querySelector('#payments-table tbody');
      tbody.innerHTML = '';
      db.ref('confirmations').on('value', snap => {
        const data = snap.val();
        for (let id in data) {
          const p = data[id];
          const row = `<tr>
            <td>${p.name}</td>
            <td>${p.email}</td>
            <td>${p.account}</td>
            <td>${p.message}</td>
            <td>${new Date(p.timestamp).toLocaleString()}</td>
            <td><button class="btn btn-danger" onclick="deletePayment('${id}')">Delete</button></td>
          </tr>`;
          tbody.innerHTML += row;
        }
      });
    }

    function deletePayment(id) {
      if (confirm("Delete this payment?")) {
        db.ref('confirmations/' + id).remove();
      }
    }

    function postPortfolio() {
      const title = document.getElementById('project-title').value;
      const desc = document.getElementById('project-desc').value;
      const link = document.getElementById('project-link').value;
      if (!title || !desc || !link) return alert("Fill all fields");
      const data = { title, desc, link, timestamp: Date.now() };
      db.ref('portfolio').push(data).then(() => {
        alert("Posted!");
        document.getElementById('project-title').value = '';
        document.getElementById('project-desc').value = '';
        document.getElementById('project-link').value = '';
      });
    }

    function loadPortfolio() {
      const tbody = document.querySelector('#portfolio-table tbody');
      tbody.innerHTML = '';
      db.ref('portfolio').on('value', snap => {
        const data = snap.val();
        for (let id in data) {
          const p = data[id];
          const row = `<tr>
            <td>${p.title}</td>
            <td>${p.desc}</td>
            <td><a href="${p.link}" target="_blank">View</a></td>
            <td>
              <button class="btn btn-warning" onclick="editPortfolio('${id}', '${p.title}', '${p.desc}', '${p.link}')">Edit</button>
              <button class="btn btn-danger" onclick="deletePortfolio('${id}')">Delete</button>
            </td>
          </tr>`;
          tbody.innerHTML += row;
        }
      });
    }

    function deletePortfolio(id) {
      if (confirm("Delete this project?")) {
        db.ref('portfolio/' + id).remove();
      }
    }

    function editPortfolio(id, title, desc, link) {
      const newTitle = prompt("Edit Title", title);
      const newDesc = prompt("Edit Description", desc);
      const newLink = prompt("Edit Link", link);
      if (newTitle && newDesc && newLink) {
        db.ref('portfolio/' + id).update({ title: newTitle, desc: newDesc, link: newLink });
      }
    }

    function exportCSV(type) {
      const ref = db.ref(type === 'payments' ? 'confirmations' : 'portfolio');
      ref.once('value', snap => {
        const data = snap.val();
        if (!data) return alert("No data to export");
        const rows = [];
        for (let id in data) {
          rows.push(Object.values(data[id]));
        }
        let csv = Object.keys(data[Object.keys(data)[0]]).join(",") + "\n";
        rows.forEach(r => { csv += r.join(",") + "\n"; });

        const blob = new Blob([csv], { type: 'text/csv' });
        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        link.download = type + '_export.csv';
        link.click();
      });
    }
  </script>
</body>
</html>